# DVC Stages

## Summary

1. [**Data Preparation**](#data-preparation)
   1. [Preprocessing (`preprocessing-*`)](#preprocessing-preprocessing-)
   2. [Plot Datasets (`plot-datasets-*`)](#plot-datasets-plot-datasets-)
   3. [M-Car Curation (`mcar-curation*`)](#m-car-curation-mcar-curation)
   4. [Dataset Organization
      (`organise-dataset`)](#dataset-organization-organise-dataset)
2. [**Feature Extraction (`features-*`)**](#feature-extraction-features-)
   1. [Feature Embedding Algorithms](#feature-embedding-algorithms)
   2. [Neurites Types](#neurite-types)
3. [**Model Training (`train*`)**](#model-training-train)
4. [**Model Evaluation (`evaluate*`)**](#model-evaluation-evaluate)
5. [**Transfer Learning
   (`transfer-learning`)**](#transfer-learning-transfer-learning)

## Data Preparation

Before using morphology datasets, we need to prepare the data. The stages in
this section make sure that the data is cleaned and organized properly.

All the data is read from and written to the folder `dvc/data/`.

### Preprocessing (`preprocess-*`)

Stages:

- `preprocess-dataset` — for interneurons and pyramidal cells
- `preprocess-janelia` — for janelia

This initial stage filters the raw data in many ways. Filtering includes
dropping duplicate files, dropping M-type classes with only 1 neuron, and other
kinds of files sorting and cleanup.

Morphologies are not modified, only paths and metadata are filtered and written
into a CSV file.

### Plot Datasets (`plot-datasets-stats*`)

Stages:

- `plot-dataset-stats` — for interneurons and pyramidal cells
- `plot-dataset-stats-janelia` — for janelia

This stage generates pretty dataset summary info: counts per M-type and per
layer, average number of nodes per neurite, examples of visualization of
morphologies per M-type, ...
**Note**: we do not track the output of this stage, you need to re-run it
manually.

### M-Car Curation (`mcar-curation*`)

Stages:

- `mcar-curation` — for interneurons and pyramidal cells
- `mcar-curation-janelia` — for janelia

This stage only executes "m-car curation" functions from Blue Brain's
[`morphology-workflows`](https://github.com/BlueBrain/morphology-workflows),
external to morphoclass. Neuronal morphologies are modified to process and
repair artifacts of in-vitro reconstructions.

### Dataset Organization (`organise-dataset`)

Stages:

- `organise-dataset` — for interneurons, pyramidal cells, janelia

Final stage of the data prep process. Morphologies are not modified, this stage
only organizes and structures in a suitable directory structure the various
files containing the neuronal morphologies.

## Feature Extraction (`features-*`)

Stages:

- `features-in-*` — for interneurons
- `features-pc-*` — for pyramidal cells
- `features-lida-janelia-*` — for janelia
- `features-lida-in-merged-*` — for interneurons with all layers merged into
  one dataset
- `features-lida-in-merged-bc-merged-*` — same as `features-lida-in-merged-*`,
  but in addition `LBC`, `NBC`, `SBC` M-types are merged in a new `BC` ("basket
  cell") type
- `features-morphometrics` — specific stage for morphometric features, for
  interneurons, pyramidal cells, janelia

These stages produce the feature embeddings of each morphology. These features
are then going to be used to feed the various Machine Learning models.

There are many stages named like `features-*`, because they are generated by
the Cartesian product of the various options possible for the choice of

- [feature embedding algorithms](#feature-embedding-algorithms)
- [neurites types](#neurite-types)

In particular, with the exception of `features-morphometrics`, all these
feature extraction stages are generated by running the script
`generate-feature-stages.py` and they adopt the following naming convention:

```text
features-<dataset>-<layer>-<feature_embedding_algorithm>-<neurite_type>
```

The `dataset`s are the ones we just mentioned:

- `in` — interneurons
- `pc` — pyramidal cells
- `janelia` — janelia
- `in-merged` — interneurons, all layers merged
- `in-merged-bc-merged` — interneurons, all layers merged and all `*BC` classes
  (i.e. all basket cells) merged

In general, the `layer` can be any of `L1`, `L2`, ..., `L6`

- **`in` (interneurons)** — `L2` and `L3` are merged into `L23`
- **`janelia` (janelia)** — we only have `L5` and `L6`, and only `L5` has
  quality good enough to be used for classification experiments
- **`pc` (pyramidal cells)** — `L1` is missing, so we only have from `L2` to
  `L6`

### Feature Embedding Algorithms

Features embeddings can be computed using various methods.

- `diagram-deepwalk` — 2D diagram of discrete points generated using
  [DeepWalk](https://arxiv.org/abs/1403.6652)
- `diagram-tmd-rd` and `diagram-tmd-proj` — 2D diagram of discrete points
  generated using Blue Brain's
  [TMD](https://link.springer.com/article/10.1007/s12021-017-9341-1) based on
  radial distance from soma or projections on the y-axis, respectively.
- `graph-rd` and `graph-proj` — graph representing the dendritic or axonal
   trees, using radial distance from soma or projections on the y-axis,
   respectively, as nodal features.
- `image-deepwalk` — 2D image obtained from `diagram-deepwalk` by applying
  [Gaussian KDE](https://en.wikipedia.org/wiki/Kernel_density_estimation)
- `image-tmd-rd` and `image-tmd-proj` — 2D image obtained from `diagram-tmd-rd`
  and `diagram-tmd-proj`, respectively, by applying
  [Gaussian KDE](https://en.wikipedia.org/wiki/Kernel_density_estimation)
- `morphometrics` — morphometric features extracted using Blue Brain's
  [NeuroM](https://github.com/BlueBrain/neurom)

From this list we can observe that feature extraction algorithms based on `tmd`
(`diagram-tmd-*` and `image-tmd-*`) or `graph` (`graph-*`) support two kinds of
nodal features to be considered.

- `rd` — radial distance from soma, this is the default and the best approach
  for most datasets.
- `proj` — projection on the y-axis, this is useful when some morphology classes
  are characterized exclusively by their "upside-down" neurites (e.g. `IPC`,
  "inverted pyramidal cells" for pyramidal cells in `L2` and `L6`), so in these
  cases we need the y-axis projection to distinguish "up" from "down".

### Neurite Types

Feature embeddings can be computed on various kinds of neurites.
The only exception are `morphometrics` embeddings, which are always computed on
`all` neurites.

- `axon` — axonal tree
- `apical` — apical dendritic tree
- `basal` — basal dendritic tree
- `all` — all neurites, i.e. `axon` + `apical` + `basal`

Notice that the morphologies in the `in` (interneurons) dataset do not have an
`apical` dendrite.

## Model Training (`train*`)

Stages:

- `train` — training for `pc` and `in` datasets using "default" neurites
- `train-alt-neurites` — training for `pc` and `in` datasets using
  non-"default" neurites
- `train-lida-in-merged` — training for `in-merged` dataset using "default"
  neurites
- `train-lida-in-merged-*` — training for `in-merged` dataset using
  non-"default" neurites
- `train-lida-in-merged-bc-merged` — training for `in-merged-bc-merged` dataset
  using "default" neurites
- `train-lida-in-merged-bc-merged-*` — training for `in-merged-bc-merged`
  dataset using non-"default" neurites
- `train-janelia-L5` — training for `janelia` dataset using "default" neurites
- `train-janelia-L5-*` — training for `janelia` dataset using non-"default"
  neurites
- `train-morphometrics` — training for alla datasets, using morphometrics
  features

By "default" neurites here we refer to the neurites that are expected to carry
most of the information required to classify morphologies by their M-types,
based on experts' feedback. This means:

- pyramidal cells (`pc` and `janelia`) — the "default" neurite is the `apical`
  dendrite
- interneurons (`in`) — the "default" neurite is the `axon` (notice that
  `apical` dendrite is missing in the `in`
  datasets)

Notice that each of these DVC stages is parametrized, so that training is run
for each of the features extracted using the [different embedding
algorithms](#feature-embedding-algorithms).  Also, notice that each type of
feature can be used to train different Machine
Learning models.

### Machine Learning models

Different Machine Learning models can be used on different kinds of features.

- **`cnn`** — [2D Convolutional Neural
  Network](https://en.wikipedia.org/wiki/Convolutional_neural_network), can be
  used on image features: `image-deepwalk`, `image-tmd-rd`, `image-tmd-proj`
- **`decision-tree`** — [Decision Tree
  classifier](https://scikit-learn.org/stable/modules/tree.html#tree), can be
  used on all sort of features, and in our case we consider: `image-deepwalk`,
  `image-tmd-rd`, `image-tmd-proj`
- **`xgb`** — [XGBoost classifier](https://xgboost.readthedocs.io/en/stable/),
  can be used on all sort of features, and in our case we consider:
  `image-deepwalk`, `image-tmd-rd`,  `image-tmd-proj`, `morphometrics`.
- **`perslay`** — [PersLay](https://arxiv.org/abs/1904.09378) can be used on
  Topologial Data Analysis descriptors in represented by a diagram:
  `diagram-deepwalk`, `diagram-tmd-rd`, `diagram-tmd-proj`
- **`gnn`** — [Graph Neural
  Network](https://pytorch-geometric.readthedocs.io/en/latest/index.html), can
  be used on graphs representing the neurite: `graph-rd`, `graph-proj`

## Model Evaluation (`evaluate*)

Stages:

- `evaluate`
- `evaluate-alt-neurites`
- `evaluate-lida-in-merged`
- `evaluate-lida-in-merged-*`
- `evaluate-lida-in-merged-bc-merged`
- `evaluate-lida-in-merged-bc-merged-*`
- `evaluate-janelia-L5`
- `evaluate-janelia-L5-*`

These stages run evaluation of the Machine Learning models trained during the
corresponding model training stage. See the [section on Model
Training](#model-training-train) for all details.

## Transfer Learning (`transfer-learning`)

Stages:

- `transfer-learning`

This stage is still in experimental phase. It implements a setting where a
model is trained on a dataset and then fine-tuned on a different one. The
accuracy of this fine-tuned model is then compared with that of a model trained
on the second dataset without pre-training.
