# DVC Stages

## Summary

1. [**Data Preparation**](#data-preparation)
   1. [Preprocessing (`preprocessing-*`)](#preprocessing-preprocessing-)
   1. [Plot Datasets (`plot-datasets-*`)](#plot-datasets-plot-datasets-)
   1. [M-Car Curation (`mcar-curation*`)](#m-car-curation-mcar-curation)
   1. [Dataset Organization
      (`organise-dataset`)](#dataset-organization-organise-dataset)
1. [**Feature Extraction (`features-*`)**](#feature-extraction-features-)
   1. [Feature Embedding Algorithms](#feature-embedding-algorithms)
   1. [Neurites Types](#neurite-types)

## Data Preparation

Before using morphology datasets, we need to prepare the data. The stages in
this section make sure that the data is cleaned and organized properly.

All the data is read from and written to the folder `dvc/data/`.

### Preprocessing (`preprocess-*`)

Stages:

- `preprocess-dataset` — for interneurons and pyramidal cells
- `preprocess-janelia` — for janelia

This initial stage filters the raw data in many ways.  Filtering includes
dropping duplicate files, dropping M-type classes with only 1 neuron, and other
kinds of files sorting and cleanup.

Morphologies are not modified, only paths and metadata are filtered and written
into a CSV file.

### Plot Datasets (`plot-datasets-stats*`)

Stages:

- `plot-dataset-stats` — for interneurons and pyramidal cells
- `plot-dataset-stats-janelia` — for janelia

This stage generates pretty dataset summary info: counts per M-type and per
layer, average number of nodes per neurite, examples of visualization of
morphologies per M-type, ...
**Note**: we do not track the output of this stage, you need to re-run it
manually.

### M-Car Curation (`mcar-curation*`)

Stages:

- `mcar-curation` — for interneurons and pyramidal cells
- `mcar-curation-janelia` — for janelia

This stage only executes "m-car curation" functions from Blue Brain's
[`morphology-workflows`](https://github.com/BlueBrain/morphology-workflows),
external to morphoclass. Neuronal morphologies are modified to process and
repair artifacts of in-vitro reconstructions.

### Dataset Organization (`organise-dataset`)

Stages:

- `organise-dataset` — for interneurons, pyramidal cells, janelia

Final stage of the data prep process. Morphologies are not modified, this stage
only organizes and structures in a suitable directory structure the various
files containing the neuronal morphologies.

## Feature Extraction (`features-*`)

Stages:

- `features-in-*` — for interneurons
- `features-pc-*` — for pyramidal cells
- `features-lida-janelia-*` — for janelia
- `features-lida-in-merged-*` — for interneurons with all layers merged into
  one dataset
- `features-lida-in-merged-bc-merged-*` — same as `features-lida-in-merged-*`,
  but in addition `LBC`, `NBC, `SBC` M-types are merged in a new `BC` type
- `features-morphometrics` — specific stage for morphometric features, for
  interneurons, pyramidal cells, janelia

These stages produce the feature embeddings of each morphology. These features
are then going to be used to feed the various Machine Learning models.

There are many stages named like `features-*`, because they are generated by
the Cartesian product of the various options possible for the choice of

- [feature embedding algorithms](#feature-embedding-algorithms)
- [neurites types](#neurite-types)

In particular, with the exception of `features-morphometrics`, all these
feature extraction stages are generated by running the script
`generate-feature-stages.py` and they adopt the following naming convention:

```text
features-<dataset>-<layer>-<feature_embedding_algorithm>-<neurite_type>
```

The `dataset`s are the ones we just mentioned:

- `in` — interneurons
- `pc` — pyramidal cells
- `janelia` — janelia
- `in-merged` — interneurons, all layers merged
- `in-merged-bc-merged` — interneurons, all layers merged and all `*BC` classes
  merged

In general, the `layer` can be any of `L1`, `L2`, ..., `L6`

- **`in` (interneurons)** — `L2` and `L3` are merged into `L23`
- **`janelia` (janelia)** — we only have `L5` and `L6`, and only `L5` has
  quality good enough to be used for classification experiments
- **`pc` (pyramidal cells)** — `L1` is missing, so we only have from `L2` to
  `L6`

### Feature Embedding Algorithms

Features embeddings can be computed using various methods.

- `diagram-deepwalk` — 2D diagram of discrete points generated using
  [DeepWalk](https://arxiv.org/abs/1403.6652)
- `diagram-tmd-rd` — 2D diagram of discrete points generated using Blue Brain's
  [TMD](https://link.springer.com/article/10.1007/s12021-017-9341-1) based on
  radial distance from soma
- `graph-rd` — graph representing the dendritic or axonal trees, using radial
  distance from soma as nodal features
- `image-deepwalk` — 2D image obtained from `diagram-deepwalk` by applying
  [Gaussian KDE](https://en.wikipedia.org/wiki/Kernel_density_estimation)
- `image-tmd-rd` — 2D image obtained from `diagram-tmd-rd` by applying
  [Gaussian KDE](https://en.wikipedia.org/wiki/Kernel_density_estimation)
- `morphometrics` — morphometric features extracted using Blue Brain's
  [NeuroM](https://github.com/BlueBrain/neurom)

### Neurite Types

Feature embeddings can be computed on various kinds of neurites.
The only exception are `morphometrics` embeddings, which are always computed on
`all` neurites.

- `basal` — basal dendritic tree
- `apical` — apical dendritic tree
- `axon` — axonal tree
- `all` — all neurites, i.e. `basal` + `apical` + `axon`

# Model Training (`train*`)

Stages:

-

## Training with Default Configurations (`train`)
